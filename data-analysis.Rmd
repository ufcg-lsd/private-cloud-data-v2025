---
title: "Exploration of  Resource Allocation and Usage for a Private Cloud"
output: html_document
---

```{r}
library(dplyr)
library(ggplot2)
library(anytime)
library(tidyr)

```


## Importing Data

```{r}
path <- "Dataset on Resource Allocation and Usage for a Private Cloud"

server_usage <- read.csv(file.path(path, "servers_usage.csv"))
user_projects <-  read.csv(file.path(path, "user_projects.csv"))
server_specs <- read.csv(file.path(path, "servers_specs.csv"))
server_ownerships <-read.csv(file.path(path, "servers_ownerships.csv"))
projects_quota <- read.csv(file.path(path, "projects_quota.csv"))
projects_quota_allocated <- read.csv(file.path(path, "projects_quota_allocated.csv"))
flavors <- read.csv(file.path(path, "flavors.csv"))


```



## Matching servers with flavors and projects. 
This way we will have the list of servers with respective flavor and project. Also, we are using the anydate lib to get a redable timestamp. 
```{r}

server_w_flavor <- inner_join(server_specs, flavors, by = "flavor_id") %>% select(-id) %>% 
                   mutate(date = anydate(timestamp))


server_ownerships <- server_ownerships %>% select(-id, -timestamp) %>% distinct()
servers_complete <- inner_join(server_w_flavor, server_ownerships, by = "server_id")

summary(servers_complete)

```


## Count instances per project.
```{r}

count_servers <- servers_complete %>% group_by(date, project_id) %>% summarise(n_instances = n_distinct(server_id))

count_servers_total <- count_servers %>% 
                       group_by(project_id) %>% 
                       summarise(total_instances = sum(n_instances)) %>% 
                       arrange(desc(total_instances))

top_5 <- count_servers_total$project_id[1:5]
count_servers_top_k <- count_servers %>% 
                 mutate(Project = if_else(project_id %in% top_5, project_id, "Others")) %>% 
                 group_by(date, Project) %>% summarise(n_instances=sum(n_instances))

```


# Figure 2 - Plot stacked area of instances per project
```{r}
base_palette <- c("#7A7A7A","#D17C2E","#3B6EA8","#8C6BB1","#6C8E4C","#A45A6B")


breaks.vec <- seq(min(count_servers_top_k$date), as.Date("2025-06-17"), by = "1 month")

paper_theme <- theme_minimal(base_size = 15, base_family = "Time") +
  theme(
    text = element_text(face = "plain"),
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    plot.title = element_blank(),
    axis.title.x = element_blank(),
    axis.line.x   = element_blank(),
    axis.ticks.x  = element_line(colour = "black", linewidth = 0.4),
    axis.ticks.length = unit(3.5, "pt"),
    axis.text.x   = element_text(margin = margin(t = 6))
  )

ggplot(count_servers_top_k, aes(x = date, y = n_instances, fill = Project)) +
  geom_area(position = "stack", alpha = 0.9) +
  scale_x_continuous(limits = c(0, 300)) +
  scale_x_date(breaks = breaks.vec, date_labels = "%b %y") +  
  labs(x = NULL, y = "Number of instances by project") +
  paper_theme  +
  scale_fill_manual(values = base_palette) + 
  theme(
    legend.position      = c(0.02, 0.98),
    legend.justification = c(0, 1),
    legend.background    = element_rect(fill = "grey95", colour = "grey55"),
    legend.key.height    = unit(5, "pt"),
    legend.key.width     = unit(14, "pt"),
    legend.margin        = margin(6, 8, 6, 8),
    plot.margin          = margin(6, 12, 6, 6),
    text = element_text(family="Times"),
  ) 

```


# Figure 3 - Plot users trough the time
```{r}
count_users <- servers_complete %>% group_by(date) %>% summarise(n_users = n_distinct(user_id))

ggplot(count_users, aes(x = date, y = n_users)) +
  geom_line(color="#D17C2E") +
  scale_y_continuous(limits = c(30, 80)) +
  scale_x_date(breaks = breaks.vec, date_labels = "%b %y") +  
  labs(x = NULL, y = "Number of users") +
  paper_theme  +
  scale_fill_manual(values = base_palette) + 
  theme(
    legend.position      = c(0.02, 0.98),
    legend.justification = c(0, 1),
    legend.background    = element_rect(fill = "grey95", colour = "grey55"),
    legend.key.height    = unit(5, "pt"),
    legend.key.width     = unit(14, "pt"),
    legend.margin        = margin(6, 8, 6, 8),
    plot.margin          = margin(6, 12, 6, 6),
    text = element_text(family="Times"),
  
  ) 
```

# Figure 4 - Plot of vcpu and RAM utilization trough the time 

```{r fig.width = 8 }

TOP_N <- 4

daily <- server_usage %>%
  mutate(day = anydate(timestamp)) %>%
  group_by(server_id, day) %>%
  summarise(
    vcpu_pct = mean(vcpu_usage, na.rm = TRUE),
    ram_pct  = mean(ram_usage,  na.rm = TRUE),
    .groups  = "drop"
  )

top_servers <- daily %>% 
  count(server_id, sort = TRUE) %>% 
  slice_head(n = TOP_N) %>% 
  pull(server_id)


daily_top <- daily %>% filter(server_id %in% top_servers)

x_min <- min(daily_top$day, na.rm = TRUE)
x_max <- max(daily_top$day, na.rm = TRUE)

month_breaks <- seq(
  from = floor_date(x_min, "month"),
  to   = floor_date(x_max, "month"),
  by   = "1 month"
)


df_long <- daily_top %>% 
  select(server_id, day,
         `vCPU utilization [%]` = vcpu_pct,
         `RAM utilization [%]`  = ram_pct) %>% 
  pivot_longer(
    cols      = c(`vCPU utilization [%]`, `RAM utilization [%]`),
    names_to  = "metric",
    values_to = "value"
  )

pal <- c(
  "#A45A6B", "#2F7F7F", "#D17C2E", "#3B6EA8",
  "#6C8E4C", "#8C6BB1", "#B07F4F", "#7A7A7A"
)
pal <- pal[seq_len(length(top_servers))]
names(pal) <- top_servers


paper_theme <- theme_minimal(base_size = 11) +
  theme(
    panel.grid.minor = element_blank(),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    axis.title.x = element_blank(),
    axis.ticks.x = element_line(colour = "black", linewidth = 0.4),
    axis.ticks.length = unit(3.5, "pt"),
    axis.text.x = element_text(margin = margin(t = 6))
  )

make_panel <- function(data_metric, show_legend = TRUE, title = NULL) {
  ggplot(data_metric,
         aes(x = day, y = value, color = server_id)) +
    geom_line(linewidth = 0.7, na.rm = TRUE) +
    scale_color_manual(values = pal,
                       name   = "Server ID",
                       guide  = if (show_legend) "legend" else "none") +
    scale_y_continuous(
      limits = c(0, 100),
      breaks = seq(0, 100, 25),
      labels = \(x) paste0(x, "%")
    ) +
    scale_x_date(
      breaks = month_breaks,
      labels = scales::label_date("%b %y", locale = "C"),
      expand = c(0, 0)
    ) +
    labs(title = title) +
    paper_theme
}

df_long %>% 
  filter(metric == "vCPU utilization [%]") %>% 
  make_panel(show_legend = FALSE,
             title = "(a) vCPU utilization")

df_long %>% 
  filter(metric == "RAM utilization [%]") %>% 
  make_panel(show_legend = FALSE,
             title = "(b) RAM utilization")


```

# Figure 5 - Violin plot

```{r}

flavors <- flavors %>% filter(flavor_name == "general.small" | flavor_name == "general.medium" | flavor_name == "general.large" | flavor_name == "general.xlarge")

server_w_flavor <- inner_join(server_specs, flavors, by = "flavor_id") %>% select(-id, -timestamp, -disk, -flavor_id) %>% na.omit() %>% distinct()

server_usage_violin <- server_usage %>% select(-host_id, -id, -vcpu_usage) %>% mutate(date=anydate(timestamp)) %>% select(-timestamp) %>% na.omit() %>% distinct()

servers_w_flavor_usage <- right_join(server_w_flavor, server_usage_violin, by = "server_id")
plot_df <- servers_w_flavor_usage %>% group_by(date, flavor_name) %>%  na.omit() %>% summarise(media_ram = mean(ram_usage))

ggplot(plot_df, aes(x=flavor_name, y=media_ram, fill=flavor_name)) +
    geom_violin(width=1) +
    theme_minimal(base_family = "Times") + scale_fill_brewer(palette = "Dark2") +
    geom_boxplot(width=0.5, color="gray", alpha=0.5) +
    theme(
      legend.position="none",
      plot.title = element_text(size=13),
      base_family = "Times"
    ) +
    ggtitle("") +
    xlab("")+
    scale_y_continuous(limits = c(0, 40))+
    ylab("RAM Usage (%)")

```

# Figure 6 - Data gaps

```{r}

contagem_na <- server_usage %>% mutate(date=anydate(timestamp), complete_date=anytime(timestamp)) %>% group_by(complete_date) %>% summarise(count_servers = n_distinct(server_id), nas =sum(is.na(vcpu_usage)))

filtered <- contagem_na %>%  filter(nas >= count_servers)

nas <- server_usage %>% mutate(date=anytime(timestamp)) %>%  filter(is.na(vcpu_usage), is.na(ram_usage)) %>% select(-id, -timestamp, -server_id, -host_id, -vcpu_usage, -ram_usage) %>% distinct()

df <- filtered %>%
  mutate(delta = as.numeric(difftime(complete_date, lag(complete_date), units = "mins")),
         group = cumsum(ifelse(is.na(delta) | delta != 5, 1, 0)))

intervals <- df %>%
  group_by(group) %>%
  summarise(
    start = min(complete_date),
    end = max(complete_date),
    length = n()
  ) %>%
  arrange(desc(length))

intervals <- intervals %>% mutate(size_interval = length * 5 ) %>% group_by(size_interval) %>% summarise(count = n())

df_plot <- contagem_na %>% mutate(gap = nas >= count_servers, date = anydate(complete_date)) %>% 
                           mutate(status = case_when((gap == TRUE) ~ "Data missing",(gap == FALSE) ~ "Data available"))

df_plot$date <- as.Date(df_plot$date)
breaks.vec <- seq(min(as.Date(df_plot$complete_date)), as.Date("2025-06-17 23:59:59", format="%Y-%m-%d %H:%M:%S"), by = "1 month")


ggplot(df_plot, aes(x = date, y = 1)) +
  geom_tile(aes(fill = status),height = Inf) +
  scale_x_date(breaks = breaks.vec, date_labels = "%b %y") +  
  geom_vline(
    data = subset(df_plot, status == "Data missing"), 
    aes(xintercept = as.numeric(date)), 
    color = "grey70", 
    linewidth = 0.5
  ) +
  scale_fill_manual(
    values = c("Data available" = "#3B6EA8", "Data missing" = alpha("grey70", 0.8))
  ) +
  theme_minimal(base_size = 15, base_family = "Times") +
  theme(
    panel.grid   = element_blank(),
    panel.grid.minor = element_blank(),
    legend.position      = c(0.80, 0.95),
    legend.justification = c(0, 1),
    legend.key.spacing.y = unit(0.1, "cm"),
    legend.title = element_blank(),
    legend.background    = element_rect(fill = "grey95", colour = "grey95"),
    panel.border = element_rect(color = "black", fill = NA, linewidth = 0.5),
    axis.ticks.x = element_line(colour = "black", linewidth = 0.4),
    axis.title.y = element_blank(),
    axis.title.x = element_blank(),
    axis.text.y = element_blank(),
    axis.ticks.y = element_blank(),
    legend.margin        = margin(6, 8, 6, 8),
    plot.margin          = margin(6, 12, 6, 6),
    axis.ticks.length = unit(3.5, "pt"),
    text = element_text(family="Times"),
  )    
  

summary(df_plot)
```



#  Figure 9 - Usage per project
```{r}

quota <- projects_quota %>% 
  mutate(ts = anytime(timestamp)) %>% 
  arrange(project_id, desc(ts)) %>% 
  group_by(project_id) %>% 
  slice_head(n = 1)  %>% 
  ungroup() %>% 
  select(project_id, quota_ram)

proj_avg <- projects_quota_allocated %>% 
  group_by(project_id) %>% 
  summarise(avg_ram_mb = mean(ram_allocated, na.rm=TRUE), .groups="drop") %>% 
  inner_join(quota, by="project_id") %>% 
  filter(is.finite(avg_ram_mb), is.finite(quota_ram), quota_ram > 0) |>
  mutate(usage_pct = pmin(100, 100 * avg_ram_mb / quota_ram))


breaks <- c(0,25,50,75,100)
labels <- c("0–25%","25–50%","50–75%","75–100%")

proj_avg <- proj_avg %>% mutate(usage_bin = cut(usage_pct, breaks=breaks, labels=labels, include.lowest=TRUE, right=TRUE))

count_bins <- proj_avg %>% 
  count(usage_bin, name="n_projects") %>% 
  complete(usage_bin=labels, fill=list(n_projects=0)) %>% 
  mutate(usage_bin = factor(usage_bin, levels = labels))

paper_theme <- theme_minimal(base_size=11, base_family="Time") +
  theme(
    panel.grid.minor = element_blank(),
    panel.border     = element_rect(color="black", fill=NA, linewidth=0.5),
    axis.text.x      = element_text(margin=margin(t=6)),
    plot.margin      = margin(10,20,25,20) 
  )
pal <- c("0–25%"="#3B6EA8","25–50%"="#8C6BB1","50–75%"="#D17C2E","75–100%"="#A45A6B")

ggplot(count_bins, aes(x=usage_bin, y=n_projects, fill=usage_bin)) +
  geom_col(width=0.7, color=NA) +
  geom_text(aes(label=n_projects), vjust=-0.3, size=3.8, family="Times") +
  scale_fill_manual(values=pal, guide="none") +
  scale_y_continuous(expand=expansion(mult=c(0,0.08))) +
  labs(
    y = "Number of projects",
    x = "Average RAM usage (% of quota)"
  ) +
  paper_theme

```


